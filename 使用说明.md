# 视频变化检测脚本使用说明

本项目提供多个脚本来检测视频前4秒（第0、1、2、3秒）是否有变化，并支持视频解码检测和筛选复制功能，专门优化用于大批量处理。

## 脚本介绍

### 1. `fast_video_detector.py` - 极速分析版本
- **功能**: 检测解码能力 + 变化检测，输出分析结果
- **适用场景**: 快速分析大批量视频
- **优化策略**: 感知哈希算法，极小尺寸处理
- **输出**: CSV报告文件

### 2. `video_filter_copy.py` - 筛选复制版本（新增）
- **功能**: 检测解码能力 + 变化检测 + 自动复制满足条件的视频
- **适用场景**: 筛选出可解码且有变化的视频到新文件夹
- **优化策略**: 快速检测 + 高效文件复制
- **输出**: 筛选后的视频文件 + 详细报告

### 3. `video_change_detector.py` - 精确版本
- **功能**: 高精度变化检测
- **适用场景**: 需要更高精确度的场合
- **优化策略**: 多算法结合（感知哈希+直方图+SSIM）
- **输出**: 详细分析报告

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 🎯 视频筛选和复制（推荐用于您的需求）

```bash
# 筛选出可解码且有变化的视频到新文件夹
python3 video_filter_copy.py /path/to/input_videos/ /path/to/output_videos/

# 使用批处理脚本（推荐）
./filter_and_copy.sh /path/to/input_videos/ /path/to/output_videos/ 8

# 保持目录结构
python3 video_filter_copy.py /path/to/videos/ /path/to/output/ --preserve-structure

# 生成详细报告
python3 video_filter_copy.py /path/to/videos/ /path/to/output/ --report analysis_report.txt

# 调整检测敏感度
python3 video_filter_copy.py /path/to/videos/ /path/to/output/ --hash-threshold 5
```

### 📊 快速分析版本

```bash
# 分析视频并生成报告（不复制文件）
python3 fast_video_detector.py /path/to/videos/ -o analysis_results.csv

# 并行处理
python3 fast_video_detector.py /path/to/videos/ -j 8 -o results.csv

# 静默模式
python3 fast_video_detector.py /path/to/videos/ -q -o results.csv
```

### 🔍 精确版本

```bash
# 高精度检测
python3 video_change_detector.py /path/to/videos/ -v

# 自定义参数
python3 video_change_detector.py /path/to/videos/ \
    --resize-width 128 \
    --resize-height 96 \
    --ssim-threshold 0.95 \
    -j 8 \
    -o detailed_results.csv
```

## 参数说明

### 筛选复制版本参数

- `input_dir`: 输入视频目录路径
- `output_dir`: 输出目录路径（复制满足条件的视频）
- `-j, --jobs`: 并行进程数（默认为CPU核心数）
- `--hash-threshold`: 哈希差异阈值（默认8，越小要求越严格）
- `--preserve-structure`: 保持原目录结构
- `--report`: 生成详细报告文件路径
- `-q, --quiet`: 静默模式
- `--extensions`: 视频文件扩展名

### 快速分析版本参数

- `input`: 输入视频文件或目录路径
- `-o, --output`: 输出CSV文件路径
- `-j, --jobs`: 并行进程数（默认为CPU核心数）
- `--hash-threshold`: 哈希差异阈值（默认8，越小要求越严格）
- `-q, --quiet`: 静默模式

### 精确版本参数

- `input`: 输入视频文件或目录路径
- `-o, --output`: 输出结果文件路径
- `-e, --extensions`: 视频文件扩展名（默认包含常见格式）
- `-j, --jobs`: 并行处理进程数
- `--resize-width/height`: 处理时的帧尺寸（越小越快）
- `--ssim-threshold`: SSIM相似度阈值（0-1，越高要求越严格）
- `--hist-threshold`: 直方图相似度阈值
- `--hash-threshold`: 感知哈希差异阈值
- `-v, --verbose`: 显示详细输出

## 性能优化建议

### 针对5万个视频的优化策略

1. **使用极速版本**: `fast_video_detector.py`
2. **合理设置进程数**: 
   ```bash
   # CPU密集型，建议使用CPU核心数
   python fast_video_detector.py videos/ -j $(nproc)
   ```
3. **分批处理**: 如果内存不足，可以分目录处理
4. **调整阈值**: 根据视频特点调整`--hash-threshold`

### 预期性能

在现代多核CPU上：
- **极速版本**: 10-50个视频/秒
- **精确版本**: 5-20个视频/秒

处理5万个视频预计时间：
- **极速版本**: 20分钟 - 2小时
- **精确版本**: 1-3小时

## 输出格式

### CSV输出示例
```csv
视频文件,无变化,详情
"/path/video1.mp4",True,"无变化"
"/path/video2.mp4",False,"第2秒有变化"
"/path/video3.mp4",False,"无法打开视频"
```

### 终端输出示例
```
找到 1000 个视频文件
使用 8 个进程

处理完成!
总数: 1000
无变化: 156
有变化: 844
用时: 45.67 秒
速度: 21.9 个/秒
```

## 检测原理

### 算法说明

1. **感知哈希**: 将帧缩放到8x8像素，转换为二进制哈希值
2. **汉明距离**: 比较哈希值的差异位数
3. **阈值判断**: 超过阈值则认为有变化

### 检测逻辑

1. 提取视频第0、1、2、3秒的关键帧
2. 计算第0秒帧的哈希值作为基准
3. 比较其他3帧与基准帧的相似度
4. 如果所有帧都足够相似，则判断为"无变化"

## 注意事项

1. **视频格式**: 支持常见格式（MP4、AVI、MOV、MKV等）
2. **视频长度**: 视频至少需要4秒长度
3. **内存使用**: 极速版本内存占用很小，适合大批量处理
4. **错误处理**: 损坏或无法读取的视频会标记为"有变化"

## 故障排除

### 常见问题

1. **ModuleNotFoundError**: 确保已安装依赖 `pip install -r requirements.txt`
2. **视频无法打开**: 检查视频文件是否损坏或格式不支持
3. **处理太慢**: 尝试减少进程数或使用极速版本
4. **内存不足**: 分批处理或减少进程数

### 测试脚本

```bash
# 创建测试视频（如果有ffmpeg）
ffmpeg -f lavfi -i testsrc=duration=10:size=320x240:rate=1 -pix_fmt yuv420p test.mp4

# 测试脚本
python fast_video_detector.py test.mp4
```

## 批量处理示例

```bash
#!/bin/bash
# 批量处理脚本示例

# 设置输入和输出目录
INPUT_DIR="/path/to/50000_videos"
OUTPUT_FILE="batch_results.csv"

# 使用极速版本处理
echo "开始处理视频..."
python fast_video_detector.py "$INPUT_DIR" \
    -o "$OUTPUT_FILE" \
    -j $(nproc) \
    --hash-threshold 8 \
    -q

echo "处理完成，结果保存在 $OUTPUT_FILE"

# 统计结果
echo "统计信息:"
echo "无变化视频数量: $(grep ',True,' "$OUTPUT_FILE" | wc -l)"
echo "有变化视频数量: $(grep ',False,' "$OUTPUT_FILE" | wc -l)"
```